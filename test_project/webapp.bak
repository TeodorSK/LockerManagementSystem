#lang racket
 
(require web-server/servlet)
(require web-server/formlets)
(require xml)
(provide/contract (start (request? . -> . response?)))

(require "model-2.rkt")

(define admin-name "Teodor")

(define (start request)
  (render-login-page
   (init-db!
    (build-path (current-directory)
                "database15.db"))
   request))

(define (render-login-page a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     `(html (head (title "Locker Management System")
                  ,@(style-link))
            (body ((class "w3-container"))
                  (div ((class "w3-content w3-margin-top"))
                       (div ((class "w3-row-padding"))

                            (div ((class "w3-card-4 w3-white w3-center"))
                                 (img ((style "max-width:50%;height:auto;")(src "https://ryersonian.ca/wp-content/uploads/2015/09/ryerson-new-logo.png")))
                                 
                                 ;(h2 "Description") 
                                 (table (tr
                                         (td
                                          (form ([action ,(embed/url login-handler)])
                                                (div ((style "text-align:center"))
                                                     (label ((for "uname")) "Username") (br)
                                                     (input ((type "text")(placeholder "Enter Username")(name "uname"))) (br)
                                                     (label ((for "psw")) "Password") (br)
                                                     (input ((type "password")(placeholder "Enter Password")(name "psw"))) (br)
                                       
                                                     (input ([class ,(button-style-class)][type "submit"] [value "Login"]))(br)
                                                     (label (input ((type "checkbox")(checked "checked")(name "remember"))" Remember me")))))
                                         (td
                                          
                                          (h1 ((style "text-align:center"))"Ryerson Locker Management System")
                                          (img ((style "max-width:70%;height:auto;display: block;
  margin-left: auto;
  margin-right: auto;
  width: 50%;")(src "https://www.ryerson.ca/content/dam/cannabis/RyersonQuad-view-from-above2.jpg")))
                                          ))))))))))

  (define (login-handler request) ;todo admin student split
    (render-admin-dashboard a-db request))
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Admin dashboard=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-admin-dashboard a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h3 (string-append "Welcome back, " ,admin-name))

                 (h4 "View")                 
                 (form ([action ,(embed/url view-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"] [value "View Lockers"])))
                 (form ([action ,(embed/url view-students-handler)])
                       (input ([class ,(button-style-class)][type "submit"] [value "View Students"])))
                 (p ((style "border-top: 3px dashed #bbb")))
                 (h4 "Import")
                 (form ([action ,(embed/url upload-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"] [value "Import Lockers"])))
                 (form ([action ,(embed/url upload-students-handler)])
                       (input ([class ,(button-style-class)][type "submit"] [value "Import Students"])))
                 (p ((style "border-top: 3px dashed #bbb")))
                 (h4 "Export")
                 (input ((class "w3-block w3-btn w3-ripple w3-blue w3-disabled")(type "submit")(value "Export Lockers"))) (br) ;placeholders                 
                 (input ((class "w3-block w3-btn w3-ripple w3-blue w3-disabled")(type "submit")(value "Export Students"))) (br) ;placeholders
                 (p ((style "border-top: 3px dashed #bbb")))
                 (h4 "Other")
                 (input ((class "w3-block w3-btn w3-ripple w3-blue w3-disabled")(type "submit")(value "Export Lock sheet")))
                 (br)
                 )
            (div ((class "w3-twothird w3-card-4"))
                 (h3 "Select an option from the menu")
                            
                 )))))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (view-lockers-handler request)
    (render-view-lockers a-db request))

  (define (view-students-handler request)
    (render-view-students a-db request))

  (define (upload-lockers-handler request)
    (render-upload-lockers a-db request))

  (define (upload-students-handler request)
    (render-upload-students a-db request))
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-View Lockers=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-view-lockers a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h3 (string-append "Welcome back, " ,admin-name))                      
                                 
                 
                 (form ([action ,(embed/url assign-locks-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "Assign locks to lockers"])))
                 (button ([class ,(button-style-class)][form "delete"][type "submit"][name "id"])"Delete selected lockers!")
                 (p ((style "border-top: 3px dashed #bbb")))
                 (form ([action ,(embed/url dashboard-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"])))
                 (br))

            (div ((class "w3-twothird w3-card-4"))
                 (table ((style "width:100%"))(tr (td (h1 "Lockers:")) (td (img ((style "max-width:25%;height:auto;float:right")(src "https://static.vecteezy.com/system/resources/thumbnails/000/583/967/small/lockers.jpg"))))))
                 
                 
                 (form ([id "delete"][action ,(embed/url clear-db-handler)])
                       ,(render-lockers a-db embed/url)))))))

  (define (assign-locks-handler request)
    (assign-locks-page a-db request))

  (define (view-locker-handler request)
    (render-view-lockers a-db request))
  
  (define (clear-db-handler request)
    (define lockers (if (exists-binding? 'id (request-bindings request))
                        (map (λ (locker) extract-binding/single 'id locker) (request-bindings request))
                        (list)))    
    (print lockers)
    (map (λ (locker) (clear-locker! a-db locker)) lockers)
    (render-view-lockers a-db (redirect/get)))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))
  
  (define (view-locker-details-handler request)
    (render-locker-details a-db request))

  (define (render-lockers a-db embed/url)   
    `(div ((class "lockers"))
          (table ([class "w3-table w3-striped w3-bordered"])(th "select all") (th "Locker number") (th "Location") (th "Details")
                 ,@(map (λ (locker)(render-locker-row locker embed/url)) (all-lockers a-db)))))

  (define (render-locker-row an-id embed/url)
    (define (id-value) (number->string an-id))
    `(tr
      (td (input ([type "checkbox"][name "id"][value ,(id-value)])))
      (td ,(id-value))
      (td ,(locker-location a-db an-id))
      (td (form ([id "details"][action ,(embed/url view-locker-details-handler)])                
                (button ([class ,(button-style-class)][form "details"][type "submit"][name "locker-details-id"][value ,(id-value)])"Details")
                ))))


  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-View Students=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-view-students a-db request)
  ;Extract filter params from bindings
  (define firstname
    (if
     (and (exists-binding? 'firstname (request-bindings request)) (non-empty-string? (extract-binding/single 'firstname (request-bindings request))))
     (extract-binding/single 'firstname (request-bindings request))
     "%"))
  (define lastname
    (if
     (and (exists-binding? 'lastname (request-bindings request)) (non-empty-string? (extract-binding/single 'lastname (request-bindings request))))
     (extract-binding/single 'lastname (request-bindings request))
     "%"))
  (define program
    (if
     (and (exists-binding? 'program (request-bindings request)) (non-empty-string? (extract-binding/single 'program (request-bindings request))))
     (extract-binding/single 'program (request-bindings request))
     "%"))
  (define email
    (if
     (and (exists-binding? 'email (request-bindings request)) (non-empty-string? (extract-binding/single 'email (request-bindings request))))
     (extract-binding/single 'email (request-bindings request))
     "%"))
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h3 (string-append "Welcome back, " ,admin-name))


                 (h3 "Filters:")
                 (form ([action ,(embed/url filter-handler)])
                       (label([for "firstname"]) "First Name:")
                       (input ([type "text"][name "firstname"][id "firstname"][placeholder "First Name"])) (br)
                       (label([for "lastname"]) "Last Name:")
                       (input ([type "text"][name "lastname"][id "lastname"][placeholder "Last name"])) (br)
                       ;(input ([type "text"][name "program"][placeholder "Program"]))
                       (label ([for "program"]) "Select Program:")
                       (select ([name "program"][id "program"])
                               (option ([value ""])"Select")
                               (option ([value "Water"])"Water")
                               (option ([value "Chemicals"])"Chemicals")
                               (option ([value "Power"])"Power")) (br)
                               
                                                                  ;make drop down menu
                                                                  (label([for "email"]) "Email:")
                                                                  (input ([type "text"][name "email"][id "email"][placeholder "Email"])) (br)
                                                                  (input ([class ,(button-style-class)][type "submit"][value "Filter"])))
                                 

                 (p ((style "border-top: 3px dashed #bbb")))
                 (button ([class ,(button-style-class)][form "assign"][type "submit"][name "id"])"Mass assign lockers")
                 (p ((style "border-top: 3px dashed #bbb")))
                 (form ([action ,(embed/url dashboard-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"])))
                 (br))

            (div ((class "w3-twothird w3-card-4"))
                 (table ((style "width:100%"))(tr (td (h1 "Students:")) (td (img ((style "max-width:20%;height:auto;float:right")(src "https://uoftmeds.com/media/k2/items/cache/f7a0a54c92471ac4480e727e4ccf93df_XL.jpg"))))))
                 (form ([id "assign"][action ,(embed/url mass-assign-handler)])
                       ,(render-students a-db embed/url)))))))

  ;placeholder
  (define (temp-handler request)
    (print "Handled!")
    (render-view-students a-db (redirect/get)))

  (define (filter-handler request)    
    (render-view-students a-db request))
  
  (define (mass-assign-handler request)    
    (confirm-mass-assign a-db request))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (view-student-details-handler request)
    (render-student-details a-db request))

  (define (render-students a-db embed/url)           
    `(div ((class "students"))
          (table ([class "w3-table w3-striped w3-bordered"])(th "select all") (th "First Name") (th "Last Name") (th "Program") (th "Email")
                 ,@(map (λ (student)(render-student-row student embed/url)) (filter-students a-db firstname lastname program email)))))
  
  (define (render-student-row an-id embed/url)
    (define (id-value) (number->string an-id))
    `(tr
      ;(td (input ,(formlet-display (checkbox (id-value) is-checked?)))) DIDN'T WORK
      (td (input ([type "checkbox"][id ,(id-value)][name "id"][value ,(id-value)])))
      ;(td ,(id-value))
      (td ,(student-firstname a-db an-id))
      (td ,(student-lastname a-db an-id))
      (td ,(student-program a-db an-id))
      (td (form ([id "details"][action ,(embed/url view-student-details-handler)])
                (button ([class ,(button-style-class)][form "details"][type "submit"][name "student-details-id"][value ,(id-value)]) "Details")))))

  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Confirm mass assign student-locker=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (confirm-mass-assign a-db request)

  ; For some reason, list of students always starts with "" - perhaps orphan form element?
  ;also could be the title?
  (define students (list-tail (map cdr (request-bindings request)) 1))
  
  (define students-with-lockers
    (filter (λ (student) (student-owns-locker? a-db student)) students))
  
  (define students-without-lockers
    (filter (λ (student) (not (student-owns-locker? a-db student))) students))
  
  (define lockers (map number->string (mass-assign-get-lockers a-db students-without-lockers)))
  
  (define owned-lockers
    (map (λ (student) (students-locker-id a-db student)) students-with-lockers))
  
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (h2 "Confirm locker assignment")
                                
                 (form ([action ,(embed/url confirm-handler)])
                       ,(if (not (empty? students-without-lockers))
                            
                            `(input ([class ,(button-style-class)][type "submit"][value "Confirm"]))
                            `(input ([class "w3-block w3-btn w3-ripple w3-blue w3-disabled"][type "submit"][value "Confirm"])))) ;Actually make disabled
                 (form ([action ,(embed/url cancel-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Cancel"]))))
                            
            (div ((class "w3-twothird w3-card-4"))

                 ,(if (not (empty? students-without-lockers))
                      `(p
                        ,(render-table students-without-lockers lockers))
                      `(p
                        (img ((style "max-width:10%;height:auto;")(src "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/OOjs_UI_icon_error-destructive.svg/1200px-OOjs_UI_icon_error-destructive.svg.png")))
                        "Error! No students selected. Please go back and select students you wish to assign lockers to."))


                 ,(if (not (empty? students-with-lockers))
                      `(p
                        (h3 "Warning: following students already have lockers")

                        ,(render-table students-with-lockers (map number->string owned-lockers)))
                      `(p))
                                
                 )))))
 
  (define (render-row student locker)
    `(tr (td ,(string-append (student-firstname a-db student) " " (student-lastname a-db student)))
         (td ,locker)))
  
  (define (render-table students lockers)
    `(table ([class "w3-table w3-striped w3-bordered"])(th "Student Ids")(th "Locker #s")
            ,@(map render-row students lockers)))

  (define (confirm-handler request)
    (mass-assign a-db students-without-lockers lockers)
    (mass-assign-successful-page a-db request))

  (define (cancel-handler request)
    (render-view-students a-db (redirect/get)))
  
  (send/suspend/dispatch response-generator))  

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Mass assign successful=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (mass-assign-successful-page a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h2 ((class "w3-text-green")) "Assignment successful!")
                 
                                
                 (form ([action ,(embed/url view-students-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< View Students"])))
                 (form ([action ,(embed/url view-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< View Lockers"])))
                 (form ([action ,(embed/url dashboard-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"]))))
                            
            (div ((class "w3-twothird w3-card-4"))                                 
                 (img ((style "max-width:100%")(src "https://i.pinimg.com/originals/35/f3/23/35f323bc5b41dc4269001529e3ff1278.gif")))
                 )))))

  (define (view-students-handler request)
    (render-view-students a-db (redirect/get)))

  (define (view-lockers-handler request)
    (render-view-lockers a-db (redirect/get)))
  
  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Assign Locks=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (assign-locks-page a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (h2 "Upload locker-lock csv file")
                 (form 
                  ([action ,(embed/url import-csv-handler)]
                   [method "POST"]
                   [enctype "multipart/form-data"])
                  ,@(formlet-display file-upload-formlet)
                  (input ([type "submit"] [value "Upload"])))

                 (form ([action ,(embed/url view-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< View Lockers"])))
                 (form ([action ,(embed/url dashboard-handler)])                                       
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"]))))
                 
                            
            (div ((class "w3-twothird w3-card-4"))                 
                                
                 )))))

  (define (view-lockers-handler request)
    (render-view-lockers a-db (redirect/get)))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (import-csv-handler request)
         
    (render-confirm-assign-locks a-db request))

  (send/suspend/dispatch response-generator))


;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Confirm assign locks=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-confirm-assign-locks a-db request)
  
  (define-values (fname fcontents)
    (formlet-process file-upload-formlet request))
  ;Saves a local copy of the upload file under name "!uploaded-filename"
  (define save-name (string-append "!uploaded-" fname));Maybe add timestamp?
  (display-to-file fcontents save-name #:exists 'replace);Limit the number of saved local files?

  (define-values (locker-ids lock-ids) (extract-locker-lock-columns a-db (open-input-file (build-path (current-directory) save-name))))
    
  (define lockers-without-locks
    (filter (λ (locker) (not (locker-has-lock? a-db locker))) locker-ids))
  
  (define lockers-with-locks
    (filter (λ (locker) (locker-has-lock? a-db locker)) locker-ids))

  (define assigned-locks
    (map (λ (locker) (number->string (lock-id a-db locker))) lockers-with-locks))

  (define new-locks
    (map (λ (index) (list-ref lock-ids index))(map (λ (locker) (index-of locker-ids locker)) lockers-without-locks)))
  (print new-locks)
  
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (h2 "Confirm lock assignment")

                 (form ([action ,(embed/url confirm-handler)])                       
                       (input ([class ,(button-style-class)][type "submit"][value "Confirm"])))
                 (form ([action ,(embed/url cancel-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Cancel"]))))
                            
            (div ((class "w3-twothird w3-card-4"))

                 ,(if (not (empty? lockers-without-locks))
                      `(p
                        ,(render-table lockers-without-locks new-locks))
                      `(p
                        (img ((style "max-width:10%;height:auto;")(src "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/OOjs_UI_icon_error-destructive.svg/1200px-OOjs_UI_icon_error-destructive.svg.png")))
                        "Error! File contains no new locker-lock relationships"))

                 ,(if (not (empty? lockers-with-locks))
                      `(p
                        (h3 "Warning: following lockers already have locks")
                        ,(render-table lockers-with-locks assigned-locks))
                      `(p))
                 
                 )))))


  (define (render-row locker lock)
    `(tr (td ,locker) (td ,lock)))
  
  (define (render-table lockers locks)
    `(table ([class "w3-table w3-striped w3-bordered"])(th "Locker IDs")(th "Lock IDs")
            ,@(map render-row lockers locks)))

  (define (confirm-handler request)    
    (assign-locks! a-db (open-input-file (build-path (current-directory) save-name)))
   
    (mass-assign-successful-page a-db request))
  
  (define (cancel-handler request)
    (render-view-lockers a-db (redirect/get)))
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Locker details=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-locker-details a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h3 (string-append "Welcome back, " ,admin-name))
                 
                 (form ([action ,(embed/url view-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Locker view"])))
                 )
                            
            (div ((class "w3-twothird w3-card-4"))
                 (h1 "Locker Details:")

                 ,(display-locker-info (extract-binding/single 'locker-details-id (request-bindings request)) embed/url)
                                
                 )))))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (view-lockers-handler request)
    (render-view-lockers a-db (redirect/get)))

  (define (student-details-handler request)
    (render-student-details a-db request))

  (define (display-locker-info id embed/url)
    (define student-id (number->string (locker-owner-id a-db id)))
    
    `(div ((class "w3-white"))
          (table ([class "w3-table w3-striped w3-bordered"])
                 (tr (td(h2 "Locker ID:"))(td ((class "w3-right-align")) (h3 ,id)))                 
                 (tr (td (h3 "Locker Location:"))(td ((class "w3-right-align")) ,(locker-location a-db id)))
                 (tr (td (h3 "Lock #:"))(td ((class "w3-right-align"))
                                            ,(if (locker-has-lock? a-db id)                             
                                                 `(div ,(number->string (lock-id a-db id)))
                                                 `(div "No Lock Assigned!"))))
                 (tr (td (h3 "Locker owner:"))(td ((class "w3-right-align"))
                                                  ,(if (locker-owned? a-db id)
                                                       `(div ,(locker-owner-name a-db id)                                                           
                                                             (form ([action ,(embed/url student-details-handler)])
                                                                   (input ([type "hidden"][id "student-details-id"][name "student-details-id"][value ,student-id]))
                                                                   (input ([class ,(button-style-class)][type "submit"][value "Student Details"]))))
                                                       `(div
                                                         "None"
                                                         (form ([action ,(embed/url add-student-locker-handler)])
                                                               (label ((for "student-id")) "Student ID:")
                                                               (input ([type "text"][id "student-id"][name "student-id"]))
                                                               (input ([type "hidden"][id "locker-id"][name "locker-id"][value ,id]))
                                                               (input ([class ,(button-style-class)][type "submit"][value "Assign"])))))))
                 (tr (td (h3 "Notes:")) (td ((class "w3-right-align")) ""))                                                                               
                 )))

  (define (add-student-locker-handler request)
    (confirm-add-student-locker a-db request))
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Student details=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-student-details a-db request)
  (define student-details-id (extract-binding/single 'student-details-id (request-bindings request)))
  
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h3 (string-append "Welcome back, " ,admin-name))

                 (form ([action ,(embed/url view-students-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Student view"]))))
                            
                            
            (div ((class "w3-twothird w3-card-4"))
                 (h1 "Student Details:")

                 ,(display-student-info student-details-id embed/url)
                                
                 )))))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))
  
  (define (view-students-handler request)
    (render-view-students a-db (redirect/get)))

  (define (add-student-locker-handler request)
    (confirm-add-student-locker a-db request))

  (define (locker-details-handler request)
    (render-locker-details a-db request))
  
  (define (display-student-info id embed/url)            
    `(div ((class "w3-white"))
          (table ([class "w3-table w3-striped w3-bordered"])
                 (tr (td  (h2 "Student ID:"))(td ((class "w3-right-align")) (h3 ,id)))  
                 (tr (td (h3 "Student Name:"))(td ((class "w3-right-align")) ,(student-name a-db id)))
                 (tr (td  (h3 "Locker:"))(td ((class "w3-right-align"))
                                             ,(if (student-owns-locker? a-db id)
                                                  `(div                 
                                                    ,(number->string (students-locker-id a-db id))
                                                    (form ([action ,(embed/url locker-details-handler)])
                                                          (input ([type "hidden"][id "locker-details-id"][name "locker-details-id"][value ,(number->string (students-locker-id a-db id))]))
                                                          (input ([class ,(button-style-class)][type "submit"][value "Locker details"]))))
                                                  `(div
                                                    "No locker assigned"
                                                    (form ([action ,(embed/url add-student-locker-handler)])
                                                          (input ([type "text"][id "locker-id"][name "locker-id"]))
                                                          (input ([type "hidden"][id "student-id"][name "student-id"][value ,id]))
                                                          (input ([class ,(button-style-class)][type "submit"][value "Add locker"])))))))
          
                 (tr (td(h3 "Notes:"))(td ((class "w3-right-align")) ""))
          
          
                             
                 )))

  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Confirm new student-locker=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (confirm-add-student-locker a-db request)
  
  (define locker-id (extract-binding/single 'locker-id (request-bindings request)))
  (define student-id (extract-binding/single 'student-id (request-bindings request)))
  
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (h2 "Confirm locker assignment")                                  
                 (form ([action ,(embed/url confirm-handler)])
                       (input ([type "hidden"][id "student-details-id"][name "student-details-id"][value ,student-id]))
                       (input ([class ,(button-style-class)][type "submit"][value "Confirm"])))
                 (form ([action ,(embed/url cancel-handler)])
                       (input ([type "hidden"][id "student-details-id"][name "student-details-id"][value ,student-id]))
                       (input ([class ,(button-style-class)][type "submit"][value "< Cancel"]))))
            (div ((class "w3-twothird w3-card-4"))
                 
                 (table ([class "w3-table w3-striped w3-bordered"])
                        (th (h2 "Student Name"))(th (h2 "Locker ID"))
                        (tr (td ,(student-name a-db student-id))(td ,locker-id)))                
                                
                 )))))
 
  (define (confirm-handler request)   
    (insert-student-locker a-db student-id locker-id "until tuesday")
    (render-student-details a-db request))

  (define (cancel-handler request)
    (render-student-details a-db request))
  
  (send/suspend/dispatch response-generator))
  
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Upload lockers=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-upload-lockers a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))                
                 (h3 "Upload locker CSV file:")
                 (form 
                  ([action ,(embed/url import-csv-handler)]
                   [method "POST"]
                   [enctype "multipart/form-data"])
                  ,@(formlet-display file-upload-formlet)
                  (input ([type "submit"] [value "Upload"])))

                 (form ([action ,(embed/url view-lockers-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< View Lockers"])))
                 (form ([action ,(embed/url dashboard-handler)])                                       
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"]))))))))
                 


  (define (view-lockers-handler request)
    (render-view-lockers a-db (redirect/get)))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (import-csv-handler request)
    (define-values (fname fcontents)
      (formlet-process file-upload-formlet request))
    ;Saves a local copy of the upload file under name "!uploaded-filename", in order to read
    (define save-name (string-append "!uploaded-" fname));Maybe add timestamp?
    (display-to-file fcontents save-name #:exists 'replace);Limit the number of saved local files?
    (db-import-locker-csv! a-db (open-input-file (build-path (current-directory) save-name)))
    (render-upload-successful-page a-db (redirect/get)))
  
  
  (send/suspend/dispatch response-generator))

;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Upload students=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-upload-students a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (h3 "Upload student CSV file:")
                 (form 
                  ([action ,(embed/url import-csv-handler)]
                   [method "POST"]
                   [enctype "multipart/form-data"])
                  ,@(formlet-display file-upload-formlet)
                  (input ([type "submit"] [value "Upload"])))
                                 
                 
                 (form ([action ,(embed/url view-students-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< View students"])))
                 (form ([action ,(embed/url dashboard-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"]))))))))


  (define (view-students-handler request)
    (render-view-students a-db (redirect/get)))

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))

  (define (import-csv-handler request)
    (define-values (fname fcontents)
      (formlet-process file-upload-formlet request))
    ;Saves a local copy of the upload file under name "!uploaded-filename"
    (define save-name (string-append "!uploaded-" fname));Maybe add timestamp?
    (display-to-file fcontents save-name #:exists 'replace);Limit the number of saved local files?
    (db-import-student-csv! a-db (open-input-file (build-path (current-directory) save-name)))
    (render-upload-successful-page a-db (redirect/get)))
  
  
  (send/suspend/dispatch response-generator))


;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-Upload success page=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
(define (render-upload-successful-page a-db request)
  (define (response-generator embed/url)
    (response/xexpr
     (html-wrapper
      `(div ((class "w3-row-padding"))
            (div ((class "w3-third w3-white w3-text-grey w3-card-4"))
                 (a ([href ,(embed/url dashboard-handler)])(img ([style "max-width:20%;"][src "https://image.flaticon.com/icons/svg/25/25694.svg"])))
                 (h2 ((class "w3-text-green")) "File upload successful!")             
                 (form ([action ,(embed/url dashboard-handler)])
                       (input ([class ,(button-style-class)][type "submit"][value "< Back to Dashboard"]))))
           
            (div ((class "w3-twothird w3-card-4"))
                 (img ((style "max-width:100%")(src "https://i.pinimg.com/originals/35/f3/23/35f323bc5b41dc4269001529e3ff1278.gif")))
                 )))))
           

  (define (dashboard-handler request)
    (render-admin-dashboard a-db (redirect/get)))
  
  (send/suspend/dispatch response-generator))

(define (style-link)
  `((link ((rel "stylesheet")
           (href "https://www.w3schools.com/w3css/4/w3.css")))))

(define (button-style-class)
  "w3-block w3-btn w3-ripple w3-blue")

(define login-formlet
  (formlet
   ,(=> (radio-group (list "Admin" "Student"))
        usertype)
   usertype))

(define file-upload-formlet
  (formlet
   (div ,{(file-upload) . => . binds})
   (let
       ([fname (bytes->string/utf-8 (binding:file-filename binds))]
        [fcontents (binding:file-content binds)])
     (values fname fcontents))))

(define (html-wrapper content)
  `(html (head (title "Locker Management System")
               ,@(style-link))
         (body ((class "w3-container"))
               (div ((class "w3-content w3-margin-top"))                       
                    ,content))))

(require web-server/servlet-env)
(serve/servlet start
               #:launch-browser? #t
               #:quit? #f
               #:listen-ip #f
               #:port 8000
               #:extra-files-paths
               (list (build-path "/c/Users/Teodor/Documents/Lockers/LockerManagementSystem/test_project/" "htdocs"))
               #:servlet-path
               "/servlets/webapp.rkt")


